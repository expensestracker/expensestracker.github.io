<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expense Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

<!-- ================= Splash / Logged Out ================= -->
<div id="logged-out-view" class="h-screen w-screen flex flex-col p-8">
  <div class="flex-grow flex flex-col items-center justify-center text-center">
    <div class="mb-8">
      <div class="inline-block bg-indigo-600 text-white p-4 rounded-2xl shadow-lg">
        <!-- Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 9V7a2 2 0 00-2-2H5a2 
                2 0 00-2 2v6a2 2 0 002 2h2m2 
                4h10a2 2 0 002-2v-6a2 2 0 
                00-2-2H9a2 2 0 00-2 2v6a2 2 
                0 002 2zm7-5a2 2 0 11-4 0 
                2 2 0 014 0z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-bold text-gray-800 mt-4">Expense Tracker</h1>
      <p class="text-gray-500 mt-1">Your project finances, simplified.</p>
      <!-- Version Code -->
      <p class="text-xs text-gray-400 mt-1">v1.0.0</p>
    </div>
  </div>
  <div class="mb-6 space-y-4">
    <button id="google-login-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg">Login with Google</button>
  </div>
</div>

<!-- ================= Logged In ================= -->
<div id="logged-in-view" class="hidden h-screen w-screen flex flex-col p-4">

  <!-- Project Selector -->
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">Select Project</h2>
    <div class="flex items-center space-x-2">
      <select id="project-select" class="form-input text-sm border p-1 rounded"></select>
      <button id="add-project-btn" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm">+ Add</button>
    </div>
  </div>

  <!-- Expense Form -->
  <form id="expense-form" class="flex space-x-2 mb-4">
    <input type="text" id="expense-title" placeholder="Title" class="form-input border p-1 rounded w-1/3">
    <input type="number" id="expense-amount" placeholder="Amount" class="form-input border p-1 rounded w-1/3">
    <button type="submit" class="bg-green-600 text-white px-4 py-1 rounded">Add</button>
  </form>

  <!-- Expenses List -->
  <ul id="expenses-list" class="space-y-2 flex-grow overflow-y-auto"></ul>

  <button id="logout-btn" class="mt-4 bg-gray-600 text-white py-2 px-4 rounded-lg">Logout</button>
</div>

<script>
  // ================= Firebase Init =================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN",
    projectId: "YOUR_PROJECT_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const appId = "construction-expenses"; // base path

  // ================= State =================
  let currentUser = null;
  let currentProjectId = null;
  let projectsUnsubscribe = null;
  let expensesUnsubscribe = null;
  let allProjects = [];

  // ================= DOM Elements =================
  const loggedOutView = document.getElementById("logged-out-view");
  const loggedInView = document.getElementById("logged-in-view");
  const loginBtn = document.getElementById("google-login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const projectSelect = document.getElementById("project-select");
  const addProjectBtn = document.getElementById("add-project-btn");
  const expenseForm = document.getElementById("expense-form");
  const expensesList = document.getElementById("expenses-list");
  const expenseTitle = document.getElementById("expense-title");
  const expenseAmount = document.getElementById("expense-amount");

  // ================= Auth =================
  loginBtn.addEventListener("click", async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  });
  logoutBtn.addEventListener("click", async () => auth.signOut());

  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      loggedOutView.classList.add("hidden");
      loggedInView.classList.remove("hidden");
      await migrateOldData(user.uid);
      listenForProjects(user.uid);
    } else {
      currentUser = null;
      loggedOutView.classList.remove("hidden");
      loggedInView.classList.add("hidden");
      if (projectsUnsubscribe) projectsUnsubscribe();
      if (expensesUnsubscribe) expensesUnsubscribe();
    }
  });

  // ================= Migration =================
  async function migrateOldData(uid) {
    const oldExpensesRef = db.collection(`artifacts/${appId}/users/${uid}/expenses`);
    const snap = await oldExpensesRef.get();
    if (snap.empty) return;

    // Ensure Default Project exists
    const projectsRef = db.collection(`artifacts/${appId}/users/${uid}/projects`);
    let defaultProjDoc = await projectsRef.where("name", "==", "Default Project").get();
    let defaultProjId;
    if (defaultProjDoc.empty) {
      const newProj = await projectsRef.add({ name: "Default Project" });
      defaultProjId = newProj.id;
    } else {
      defaultProjId = defaultProjDoc.docs[0].id;
    }

    // Move expenses
    const batch = db.batch();
    snap.forEach(doc => {
      const newRef = db.collection(`artifacts/${appId}/users/${uid}/projects/${defaultProjId}/expenses`).doc(doc.id);
      batch.set(newRef, doc.data());
      batch.delete(doc.ref);
    });
    await batch.commit();
  }

  // ================= Projects =================
  function listenForProjects(uid) {
    if (projectsUnsubscribe) projectsUnsubscribe();
    const projectsRef = db.collection(`artifacts/${appId}/users/${uid}/projects`);
    projectsUnsubscribe = projectsRef.onSnapshot(snapshot => {
      allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderProjects();
    });
  }

  function renderProjects() {
    projectSelect.innerHTML = "";
    if (allProjects.length === 0) {
      projectSelect.innerHTML = `<option disabled selected>No Projects</option>`;
      return;
    }
    allProjects.forEach(proj => {
      const opt = document.createElement("option");
      opt.value = proj.id;
      opt.textContent = proj.name;
      if (!currentProjectId) currentProjectId = proj.id;
      if (proj.id === currentProjectId) opt.selected = true;
      projectSelect.appendChild(opt);
    });
    listenForExpenses(currentUser.uid, currentProjectId);
  }

  addProjectBtn.addEventListener("click", async () => {
    const name = prompt("Enter new project name:");
    if (name && currentUser) {
      const projectsRef = db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects`);
      await projectsRef.add({ name });
    }
  });

  projectSelect.addEventListener("change", e => {
    currentProjectId = e.target.value;
    listenForExpenses(currentUser.uid, currentProjectId);
  });

  // ================= Expenses =================
  function listenForExpenses(uid, projectId) {
    if (expensesUnsubscribe) expensesUnsubscribe();
    const expensesRef = db.collection(`artifacts/${appId}/users/${uid}/projects/${projectId}/expenses`);
    expensesUnsubscribe = expensesRef.orderBy("createdAt", "desc").onSnapshot(snapshot => {
      expensesList.innerHTML = "";
      snapshot.forEach(doc => {
        const exp = doc.data();
        const li = document.createElement("li");
        li.className = "p-2 border rounded flex justify-between";
        li.innerHTML = `<span>${exp.title} - â‚¹${exp.amount}</span>
          <button class="text-red-500" onclick="deleteExpense('${uid}','${projectId}','${doc.id}')">x</button>`;
        expensesList.appendChild(li);
      });
    });
  }

  expenseForm.addEventListener("submit", async e => {
    e.preventDefault();
    if (!expenseTitle.value || !expenseAmount.value) return;
    const expensesRef = db.collection(`artifacts/${appId}/users/${currentUser.uid}/projects/${currentProjectId}/expenses`);
    await expensesRef.add({
      title: expenseTitle.value,
      amount: parseFloat(expenseAmount.value),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    expenseTitle.value = "";
    expenseAmount.value = "";
  });

  window.deleteExpense = async (uid, projectId, expId) => {
    const ref = db.doc(`artifacts/${appId}/users/${uid}/projects/${projectId}/expenses/${expId}`);
    await ref.delete();
  };
</script>
</body>
</html>
