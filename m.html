<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login View -->
    <div id="login-view" class="flex flex-col items-center justify-center h-screen">
        <div class="p-8 bg-white rounded-lg shadow-md text-center w-full max-w-sm">
            <h1 class="text-2xl font-bold mb-4">Admin Panel Login</h1>
            <p class="text-gray-600 mb-6">Please sign in to manage the application.</p>
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700 transition">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main Admin View -->
    <div id="admin-view" class="hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl font-semibold">User Management</h1>
                    <div class="flex items-center space-x-4">
                        <span id="admin-email" class="text-sm text-gray-600"></span>
                        <button id="logout-btn" class="text-sm text-indigo-600 hover:underline">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h2 class="text-lg font-semibold">Registered Users</h2>
                    <button id="refresh-btn" class="text-sm bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300 disabled:opacity-50">
                        Refresh
                    </button>
                </div>
                <p id="error-message" class="text-red-500 text-center mb-4 hidden"></p>
                <div id="loader" class="text-center py-4">Loading users...</div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">UID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-list" class="bg-white divide-y divide-gray-200">
                            <!-- User rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // --- Firebase Configuration ---
        // IMPORTANT: Use the same Firebase config as your main app
        const firebaseConfig = {
            apiKey: "AIzaSyAEZsRWj_7ZAVfwW8PR7Nj4c2rR3gbeGw0",
            authDomain: "construction-expenses-app.firebaseapp.com",
            projectId: "construction-expenses-app",
            storageBucket: "construction-expenses-app.firebasestorage.app",
            messagingSenderId: "944353147981",
            appId: "1:944353147981:web:36ff635b184d5eac69b004"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const adminEmailEl = document.getElementById('admin-email');
        const userListEl = document.getElementById('user-list');
        const userTable = userListEl.closest('table');
        const loader = document.getElementById('loader');
        const errorEl = document.getElementById('error-message');
        const refreshBtn = document.getElementById('refresh-btn');

        // --- Firebase Callable Functions ---
        const listUsers = httpsCallable(functions, 'listUsers');
        const enableUser = httpsCallable(functions, 'enableUser');
        const disableUser = httpsCallable(functions, 'disableUser');

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // In a real app, you would check for an admin custom claim here
                adminEmailEl.textContent = user.email;
                loginView.style.display = 'none';
                adminView.style.display = 'block';
                fetchAndRenderUsers();
            } else {
                loginView.style.display = 'flex';
                adminView.style.display = 'none';
            }
        });

        loginBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => {
                console.error("Login failed:", err);
                alert("Login failed. Check the console for details.");
            });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        refreshBtn.addEventListener('click', fetchAndRenderUsers);

        // --- User Management Logic ---
        async function fetchAndRenderUsers() {
            loader.style.display = 'block';
            userTable.style.display = 'none';
            errorEl.style.display = 'none';
            refreshBtn.disabled = true;

            try {
                const result = await listUsers();
                const users = result.data.users;
                renderUsers(users);
                userTable.style.display = 'table';
            } catch (err) {
                console.error("Error fetching users:", err);
                errorEl.textContent = 'Failed to fetch users. You may not have permission to perform this action.';
                errorEl.style.display = 'block';
            } finally {
                loader.style.display = 'none';
                refreshBtn.disabled = false;
            }
        }

        function renderUsers(users) {
            userListEl.innerHTML = ''; // Clear existing list
            users.forEach(user => {
                const tr = document.createElement('tr');
                const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'U')}&background=E2E8F0&color=4A5568`;
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10"><img class="h-10 w-10 rounded-full" src="${photoURL}" alt=""></div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.displayName || 'N/A'}</div>
                                <div class="text-sm text-gray-500">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.uid}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.disabled ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            ${user.disabled ? 'Disabled' : 'Active'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-uid="${user.uid}" data-disabled="${user.disabled}" class="toggle-status-btn font-semibold rounded-md px-3 py-1 ${user.disabled ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-red-100 text-red-800 hover:bg-red-200'}">
                            ${user.disabled ? 'Enable' : 'Disable'}
                        </button>
                    </td>
                `;
                userListEl.appendChild(tr);
            });

            // Add event listeners to the new buttons
            document.querySelectorAll('.toggle-status-btn').forEach(btn => {
                btn.addEventListener('click', handleToggleUserStatus);
            });
        }

        async function handleToggleUserStatus(event) {
            const btn = event.currentTarget;
            const uid = btn.dataset.uid;
            const isDisabled = btn.dataset.disabled === 'true';

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const action = isDisabled ? enableUser : disableUser;
                await action({ uid });
                fetchAndRenderUsers(); // Refresh the list on success
            } catch (err) {
                console.error("Failed to toggle user status:", err);
                alert(`Error: ${err.message}`);
                btn.disabled = false; // Re-enable button on failure
                btn.textContent = isDisabled ? 'Enable' : 'Disable';
            }
        }
    </script>
</body>
</html>
