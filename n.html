<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Unassigned Expenses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <div class="w-full max-w-lg p-8 bg-white rounded-lg shadow-md text-center">
        <h1 class="text-2xl font-bold text-gray-800">Assign Expenses Tool</h1>
        <p id="status-message" class="text-gray-600 mt-2 mb-6">This script finds expenses not assigned to any project and moves them to your "General" project.</p>
        
        <div id="auth-view">
            <button id="google-signin-btn" class="btn w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out inline-flex items-center justify-center shadow-md">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Sign in with Google
            </button>
        </div>

        <div id="script-view" class="hidden">
             <button id="run-script-btn" class="btn w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out">
                Assign Expenses to General Project
            </button>
        </div>

        <div id="logs" class="mt-6 text-left text-sm text-gray-500 bg-gray-50 p-4 rounded-md h-48 overflow-y-auto border">
            <p>Logs will appear here...</p>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, writeBatch, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEZsRWj_7ZAVfwW8PR7Nj4c2rR3gbeGw0",
            authDomain: "construction-expenses-app.firebaseapp.com",
            projectId: "construction-expenses-app",
            storageBucket: "construction-expenses-app.firebasestorage.app",
            messagingSenderId: "944353147981",
            appId: "1:944353147981:web:36ff635b184d5eac69b004"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const statusMessage = document.getElementById('status-message');
        const authView = document.getElementById('auth-view');
        const scriptView = document.getElementById('script-view');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const runScriptBtn = document.getElementById('run-script-btn');
        const logsEl = document.getElementById('logs');
        let currentUser = null;

        function log(message) {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsEl.appendChild(p);
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        googleSignInBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                log(`Sign-in failed: ${error.message}`);
            });
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authView.classList.add('hidden');
                scriptView.classList.remove('hidden');
                statusMessage.textContent = `Signed in as ${user.email}. Ready to run script.`;
                logsEl.innerHTML = '<p>Ready. Click the button to begin.</p>';
            } else {
                authView.classList.remove('hidden');
                scriptView.classList.add('hidden');
                statusMessage.textContent = 'Please sign in to run the migration script.';
            }
        });

        async function assignUnassignedExpenses() {
            if (!currentUser) {
                log("Error: You must be signed in to run this script.");
                return;
            }

            const uid = currentUser.uid;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'construction-expenses';
            const projectsRef = collection(db, `artifacts/${appId}/users/${uid}/projects`);
            const expensesRef = collection(db, `artifacts/${appId}/users/${uid}/expenses`);
            let generalProjectId;

            try {
                log("Step 1: Finding or creating 'General' project...");
                const q = query(projectsRef, where("name", "==", "General"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    log("No 'General' project found. Creating one...");
                    const newProjectDoc = await addDoc(projectsRef, { name: "General" });
                    generalProjectId = newProjectDoc.id;
                    log(`Created 'General' project with ID: ${generalProjectId}`);
                } else {
                    generalProjectId = querySnapshot.docs[0].id;
                    log(`Found 'General' project with ID: ${generalProjectId}`);
                }
            } catch (error) {
                log(`Error in Step 1: ${error.message}`);
                return;
            }

            try {
                log("Step 2: Finding all expenses without a project ID...");
                const qExpenses = query(expensesRef, where("projectId", "==", null));
                const expensesToMigrateSnapshot = await getDocs(qExpenses);

                if (expensesToMigrateSnapshot.empty) {
                    log("Success: No unassigned expenses found. Your data is already up-to-date.");
                    return;
                }

                log(`Found ${expensesToMigrateSnapshot.size} unassigned expenses to update.`);
                
                log("Step 3: Updating expenses in a batch. Please wait...");
                const batch = writeBatch(db);
                expensesToMigrateSnapshot.forEach(doc => {
                    batch.update(doc.ref, { projectId: generalProjectId });
                });

                await batch.commit();
                log(`Success! Migrated ${expensesToMigrateSnapshot.size} expenses to the 'General' project.`);
                alert(`Migration complete! ${expensesToMigrateSnapshot.size} expenses were updated.`);

            } catch (error) {
                log(`Error during migration (Step 2/3): ${error.message}`);
            }
        }

        runScriptBtn.addEventListener('click', async () => {
            runScriptBtn.disabled = true;
            runScriptBtn.textContent = "Running...";
            logsEl.innerHTML = '';
            
            await assignUnassignedExpenses();
            
            runScriptBtn.disabled = false;
            runScriptBtn.textContent = "Assign Expenses to General Project";
        });

    </script>
</body>
</html>
